{% extends "base.html" %}
{% load static %}
{% block title %}Banking Dashboard{% endblock %}

{% block content %}
<section class="bg-gray-50 dark:bg-gray-900 min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-white dark:bg-gray-800 shadow-lg hidden md:block">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ğŸ¦ MyBank</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Welcome, {{ user.username|capfirst }}</p>
    </div>

    <nav class="mt-6 space-y-2">
      <a href="{% url 'accounts:dashboard' %}" class="block px-6 py-3 bg-blue-50 dark:bg-gray-700 rounded-r-full font-medium text-gray-800 dark:text-white">ğŸ  Dashboard</a>
      <a href="{% url 'accounts:home' %}" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-r-full font-medium">ğŸ’° Accounts</a>
      <a href="{% url 'accounts:cards' %}" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-r-full font-medium">ğŸ’³ Cards</a>
      <a href="{% url 'accounts:transfers' %}" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-r-full font-medium">ğŸ“¤ Transfers</a>
      <a href="{% url 'accounts:settings' %}" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-r-full font-medium">âš™ï¸ Settings</a>
      <a href="{% url 'accounts:logout' %}" class="block px-6 py-3 mt-8 bg-gradient-to-r from-red-500 to-red-700 text-white font-medium rounded-r-full hover:opacity-90 text-center">Logout</a>
    </nav>
  </aside>

  <!-- Main Dashboard -->
  <main class="flex-1 p-8">

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-1">
          Hello, {{ user.first_name|default:user.username|capfirst }} ğŸ‘‹
        </h1>
        <p class="text-gray-500 dark:text-gray-400 text-sm">
          Last login: {{ user.last_login|date:"d M Y, h:i A" }}
        </p>
      </div>

      <!-- âœ… Fixed button ID -->
      <button id="openTransferModal"
        class="mt-4 md:mt-0 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-5 py-2.5 rounded-lg shadow hover:shadow-lg transition">
        + New Transfer
      </button>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow hover:shadow-lg transition">
        <h2 class="text-gray-500 dark:text-gray-400 text-sm uppercase">Total Balance</h2>
        <p class="text-3xl font-bold text-green-600 mt-2">
          â‚¹{{ balance|default:"0.00" }}
        </p>
        <p class="text-sm text-gray-400 mt-1">Net Available Balance</p>
      </div>

      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow hover:shadow-lg transition">
        <h2 class="text-gray-500 dark:text-gray-400 text-sm uppercase">Total Income</h2>
        <p class="text-3xl font-bold text-blue-600 mt-2">
          â‚¹{{ total_credit|default:"0.00" }}
        </p>
        <p class="text-sm text-gray-400 mt-1">All credits received</p>
      </div>

      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow hover:shadow-lg transition">
        <h2 class="text-gray-500 dark:text-gray-400 text-sm uppercase">Total Spent</h2>
        <p class="text-3xl font-bold text-red-500 mt-2">
          â‚¹{{ total_debit|default:"0.00" }}
        </p>
        <p class="text-sm text-gray-400 mt-1">All debits processed</p>
      </div>
    </div>

    <!-- Transactions Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mb-10">
      <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Recent Transactions</h2>
      {% if transactions %}
      <div class="overflow-x-auto">
        <table class="w-full text-left text-gray-700 dark:text-gray-300">
          <thead class="bg-gray-100 dark:bg-gray-700">
            <tr>
              <th class="py-3 px-4">Date</th>
              <th class="py-3 px-4">Description</th>
              <th class="py-3 px-4">Type</th>
              <th class="py-3 px-4">Amount</th>
              <th class="py-3 px-4 text-right">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for txn in transactions %}
            <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
              <td class="py-3 px-4">{{ txn.created_at|date:"d M Y" }}</td>
              <td class="py-3 px-4">{{ txn.description }}</td>
              <td class="py-3 px-4 capitalize">{{ txn.transaction_type }}</td>
              <td class="py-3 px-4 {% if txn.transaction_type == 'debit' %}text-red-500{% else %}text-green-600{% endif %}">
                {% if txn.transaction_type == 'debit' %}-{% else %}+{% endif %} â‚¹{{ txn.amount }}
              </td>
              <td class="py-3 px-4 text-right {% if txn.status == 'Completed' %}text-green-500{% else %}text-yellow-500{% endif %}">
                {{ txn.status }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-gray-500 dark:text-gray-400 italic">No transactions found yet.</p>
      {% endif %}
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <button id="openTransferModal2" class="p-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center">
        ğŸ’¸ Transfer Money
      </button>
      <a href="{% url 'accounts:transfers' %}" class="p-6 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center">
        ğŸ“Š View Statements
      </a>
      <a href="{% url 'accounts:settings' %}" class="p-6 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center">
        âš™ï¸ Manage Account
      </a>
    </div>
    <!-- Live Face Stream & Status -->
<div class="fixed top-6 right-8 z-50 bg-white dark:bg-gray-800 shadow-lg rounded-xl p-3 flex items-center space-x-3 border border-gray-200 dark:border-gray-700">
  <!-- Status Indicator -->
  <div id="faceStatus" class="w-4 h-4 rounded-full bg-gray-400 animate-pulse"></div>
  <span id="statusText" class="text-sm font-medium text-gray-700 dark:text-gray-300">Initializing...</span>
  <!-- Live camera preview -->
  <video id="faceStream" autoplay muted playsinline class="ml-4 w-28 h-20 rounded-lg object-cover border border-gray-300 dark:border-gray-600"></video>
</div>

  </main>
</section>

<!-- Include transfer modal -->
{% include "accounts/_transfer_modal.html" %}

<!-- Script to handle modal -->
<script>
const video = document.getElementById("faceStream");
const dot = document.getElementById("faceStatus");
const text = document.getElementById("statusText");
let failureCount = 0;

// Start webcam stream
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    video.srcObject = stream;
    video.play();
    text.textContent = "Camera active";
    dot.className = "w-3 h-3 rounded-full bg-blue-500 animate-pulse";
    startContinuousVerification(stream);
  })
  .catch(err => {
    text.textContent = "Camera access denied";
    dot.className = "w-3 h-3 rounded-full bg-red-600";
  });

// Main verification loop
function startContinuousVerification(stream) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  async function captureAndVerify() {
    try {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const captured_image = canvas.toDataURL("image/png");

      const res = await fetch("{% url 'accounts:reverify_face' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ captured_image })
      });
      const data = await res.json();

      if (data.status === "valid") {
        failureCount = 0;
        dot.className = "w-3 h-3 rounded-full bg-green-500";
        text.textContent = "Verified";
      } 
      else if (data.status === "invalid") {
        failureCount++;
        dot.className = "w-3 h-3 rounded-full bg-red-500 animate-pulse";
        text.textContent = `Mismatch #${failureCount}`;

        // ğŸš¨ Auto logout â€” non-blocking
        if (failureCount >= 3) {
          text.textContent = "Security breach â€” logging out...";
          dot.className = "w-3 h-3 rounded-full bg-red-600 animate-ping";

          setTimeout(() => {
            window.location.replace("{% url 'accounts:logout' %}");
          }, 1500);
        }
      }
    } catch (err) {
      dot.className = "w-3 h-3 rounded-full bg-yellow-400";
      text.textContent = "Verification error";
    }
  }

  // Run every second (1s)
  setInterval(captureAndVerify, 1000);
}
</script>


{% endblock %}
