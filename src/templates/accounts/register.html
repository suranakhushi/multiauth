{% extends '../base.html' %}
{% block title %}Register{% endblock %}

{% block head %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    background: radial-gradient(circle at 20% 20%, #0f172a, #1e293b, #0f172a);
    color: #111;
}

/* Landing Section */
.landing-section {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    position: relative;
}

/* Glow background */
.glow-bg {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, rgba(56,189,248,0.1), rgba(139,92,246,0.1), rgba(236,72,153,0.1));
    filter: blur(100px);
    animation: pulse 8s infinite alternate;
    z-index: 0;
}

@keyframes pulse {
    0% { transform: scale(1) rotate(0deg); opacity: 0.8; }
    100% { transform: scale(1.2) rotate(10deg); opacity: 1; }
}

/* Card container */
.landing-card {
    position: relative;
    width: 100%;
    max-width: 1200px;
    background: #fff;
    border-radius: 2rem;
    padding: 3rem 4rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items: start;
    box-shadow: 0 0 30px rgba(0,0,0,0.2);
    z-index: 2;
}

@media (max-width: 1024px) {
    .landing-card { grid-template-columns: 1fr; padding: 2rem; }
}

/* Headings */
.landing-card h2 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: #111;
}

/* Labels style */
.landing-card label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

/* Form inputs */
.landing-card input, .landing-card select {
    width: 100%;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    border-radius: 0.75rem;
    border: 1px solid rgba(0,0,0,0.15);
    background: #f9fafb;
    color: #111;
    outline: none;
    transition: all 0.3s ease;
    font-size: 0.95rem;
}

.landing-card input:focus, .landing-card select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 10px rgba(59,130,246,0.3);
}

/* Error messages */
.field-error {
    color: #ef4444;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

/* Webcam card */
.camera-card {
    background: #fff;
    border: 2px solid #3b82f6;
    border-radius: 1.5rem;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 25px rgba(59,130,246,0.3);
}

.camera-card video {
    border-radius: 1rem;
    border: 2px solid #3b82f6;
    max-width: 100%;
}

/* Buttons */
#captureBtn, #registerSubmit {
    padding: 1rem 2rem;
    font-weight: 600;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

#captureBtn {
    background: linear-gradient(135deg, #10b981, #06b6d4);
    color: #fff;
    margin-top: 1rem;
    box-shadow: 0 0 10px #10b981, 0 0 20px #06b6d4;
}

#captureBtn:hover { transform: translateY(-2px) scale(1.03); }

#registerSubmit {
    background: linear-gradient(135deg, #3b82f6, #9333ea);
    color: #fff;
    margin-top: 2rem;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 0 10px #3b82f6, 0 0 20px #9333ea;
}

/* Webcam preview */
#preview {
    margin-top: 1rem;
    border-radius: 1rem;
    box-shadow: 0 0 15px rgba(59,130,246,0.3);
    animation: float 6s ease-in-out infinite;
}

@keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

/* Animated messages */
.message-box {
    position: absolute;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    padding: 1rem 2rem;
    border-radius: 1rem;
    font-weight: 600;
    text-align: center;
    opacity: 0;
    pointer-events: none;
    transition: all 0.5s ease;
    z-index: 20;
    font-size: 0.95rem;
}

.message-success { background: #10b981; color: #fff; }
.message-error { background: #ef4444; color: #fff; }

.message-box.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
</style>
{% endblock %}

{% block content %}
<section class="landing-section">
    <div class="glow-bg"></div>
    <div class="landing-card">
        <!-- Form -->
        <div>
            <h2>Create New Account</h2>

            <div id="msgBox" class="message-box"></div>

            <form method="POST" enctype="multipart/form-data" action="{% url 'accounts:register' %}">
                {% csrf_token %}
                <div class="grid gap-4 sm:grid-cols-2 sm:gap-4">
                    <div class="w-full">
                        <label>First Name</label>
                        {{ form.first_name }}
                        {% for error in form.first_name.errors %}
                            <p class="field-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div class="w-full">
                        <label>Last Name</label>
                        {{ form.last_name }}
                        {% for error in form.last_name.errors %}
                            <p class="field-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div class="sm:col-span-2">
                        <label>Username</label>
                        {{ form.username }}
                        {% for error in form.username.errors %}
                            <p class="field-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div class="sm:col-span-2">
                        <label>Email</label>
                        {{ form.email }}
                        {% for error in form.email.errors %}
                            <p class="field-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div>
                        <label>Password</label>
                        {{ form.password1 }}
                        {% for error in form.password1.errors %}
                            <p class="field-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div>
                        <label>Confirm Password</label>
                        {{ form.password2 }}
                        {% for error in form.password2.errors %}
                            <p class="field-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div class="w-full">
                        <label>Phone Number</label>
                        {{ form.phone_number }}
                        {% for error in form.phone_number.errors %}
                            <p class="field-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div>
                        <label>Gender</label>
                        {{ form.gender }}
                        {% for error in form.gender.errors %}
                            <p class="field-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <input type="hidden" name="captured_image" id="capturedImageInput" />

                <div class="w-full text-center mt-6">
                    <button type="submit" id="registerSubmit">Register</button>
                </div>
            </form>
        </div>

        <!-- Camera -->
        <div class="camera-card">
            <h3 class="mb-3 font-semibold">Capture Your Face</h3>
            <video id="camera" width="320" height="240" autoplay playsinline muted></video>
            <canvas id="snapshot" width="320" height="240" style="display:none;"></canvas>
            <img id="preview" alt="" style="display:none;width:160px;height:auto;" />
            
            <button type="button" id="captureBtn">Capture Face</button>
            <p class="text-sm mt-2">After capturing, click Register.</p>
        </div>
    </div>
</section>

<script>
const video = document.getElementById('camera');
const canvas = document.getElementById('snapshot');
const ctx = canvas.getContext('2d');
const captureBtn = document.getElementById('captureBtn');
const capturedImageInput = document.getElementById('capturedImageInput');
const preview = document.getElementById('preview');
const msgBox = document.getElementById('msgBox');

navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => { video.srcObject = stream; })
  .catch(err => { showMessage('Camera permission denied', 'error'); });

captureBtn.addEventListener('click', () => {
  if (!video.srcObject) return showMessage('No camera detected', 'error');

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = canvas.toDataURL('image/png');

  if (!imageData || !imageData.startsWith('data:image/')) {
      showMessage('Face not detected. Try again.', 'error');
      return;
  }

  capturedImageInput.value = imageData;
  preview.src = imageData;
  preview.style.display = 'block';
  showMessage('Face captured successfully!', 'success');
});

document.querySelector('form').addEventListener('submit', (e) => {
  if (!capturedImageInput.value || !capturedImageInput.value.startsWith('data:image/')) {
    e.preventDefault();
    showMessage('Please capture your face before submitting.', 'error');
  }
});

function showMessage(text, type) {
    msgBox.textContent = text;
    msgBox.className = 'message-box show ' + (type === 'success' ? 'message-success' : 'message-error');
    setTimeout(() => { msgBox.className = 'message-box'; }, 3500);
}
</script>
{% endblock %}
