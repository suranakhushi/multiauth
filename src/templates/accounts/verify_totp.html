from django_otp.plugins.otp_totp.models import TOTPDevice
from django.contrib.auth.decorators import login_required
from django.http import JsonResponse
from django.contrib import messages
from django.shortcuts import render, redirect

@login_required
def verify_totp(request):
    """Verify user's TOTP code from their authenticator app (AJAX + fallback)."""
    user = request.user

    # Find existing TOTP device (either unconfirmed or confirmed)
    device = (
        TOTPDevice.objects.filter(user=user, confirmed=False).first()
        or TOTPDevice.objects.filter(user=user, confirmed=True).first()
    )

    if not device:
        # No device set up ‚Üí redirect to setup
        if request.headers.get("x-requested-with") == "XMLHttpRequest":
            return JsonResponse({"ok": False, "error": "No TOTP device found. Please set up first."}, status=400)
        messages.error(request, "No TOTP device found. Please set up first.")
        return redirect("accounts:setup_totp")

    # --- POST: user submitting 6-digit token ---
    if request.method == "POST":
        token = request.POST.get("token", "").strip()

        if device.verify_token(token):
            device.confirmed = True
            device.save()

            if request.headers.get("x-requested-with") == "XMLHttpRequest":
                return JsonResponse({"ok": True})  # ‚úÖ handled by JS in auth_flow.html

            messages.success(request, "üéâ Two-factor authentication verified successfully!")
            return redirect("accounts:dashboard")

        else:
            if request.headers.get("x-requested-with") == "XMLHttpRequest":
                return JsonResponse({"ok": False, "error": "Invalid or expired code. Try again."}, status=400)

            messages.error(request, "‚ùå Invalid or expired code. Please try again.")

    # --- GET: render fallback HTML form ---
    return render(request, "accounts/verify_totp.html")
